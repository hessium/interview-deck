# Boost asio –ø—Ä–∏–º–µ—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —Å–µ—Ç–µ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞

## –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±–∑–æ—Ä —Ç–µ–º, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è. –ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä. –ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä. –î—Ä—É–≥–∏–µ –≤–æ–ø—Ä–æ—Å—ã —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π boost::asio

---

## –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π TCP-—Å–µ—Ä–≤–µ—Ä —Å –¥–≤—É–º—è –æ—á–µ—Ä–µ–¥—è–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

```c++
// server_sync.cpp

using boost::asio::ip::tcp;

std::deque<std::string> incoming_messages;
std::deque<std::string> processing_queue;
std::mutex queue_mutex;

void accept_and_read(tcp::acceptor& acceptor) {
    while (true) {
        tcp::socket socket(acceptor.get_executor().context());
        acceptor.accept(socket);

        char data[1024];
        boost::system::error_code ec;
        size_t length = socket.read_some(boost::asio::buffer(data), ec);

        if (!ec) {
            std::string msg(data, length);
            std::lock_guard<std::mutex> lock(queue_mutex);
            incoming_messages.push_back(msg);
        }
    }
}

void process_messages() {
    while (true) {
        {
            std::lock_guard<std::mutex> lock(queue_mutex);
            if (!incoming_messages.empty()) {
                processing_queue.swap(incoming_messages);  // –ë—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –±–µ–∑ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            }
        }

        while (!processing_queue.empty()) {
            std::string msg = processing_queue.front();
            processing_queue.pop_front();
            std::cout << "Processing: " << msg << std::endl;
        }

        std::this_thread::sleep_for(std::chrono::milliseconds(100));
    }
}

int main() {
    try {
        boost::asio::io_context io_context;
        tcp::acceptor acceptor(io_context, tcp::endpoint(tcp::v4(), 12345));

        std::thread accept_thread([&]() { accept_and_read(acceptor); });
        std::thread process_thread(process_messages);

        accept_thread.join();
        process_thread.join();
    } catch (std::exception& e) {
        std::cerr << "Exception: " << e.what() << "\n";
    }
}
```

- `incoming_messages` ‚Äî –∑–∞—â–∏—â—ë–Ω–Ω–∞—è mutex –æ—á–µ—Ä–µ–¥—å, –∫—É–¥–∞ —Å–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ.
- `processing_queue` ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å, —Å –∫–æ—Ç–æ—Ä–æ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏.
- `swap` –º–µ–∂–¥—É –Ω–∏–º–∏ ‚Äî –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è std::mutex (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ, –Ω–µ –∫–æ–ø–∏—Ä—É—è —ç–ª–µ–º–µ–Ω—Ç—ã).
- –¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ —Å–Ω–∏–∂–∞–µ—Ç –≤—Ä–µ–º—è –∑–∞—Ö–≤–∞—Ç–∞ –º—å—é—Ç–µ–∫—Å–∞ –∏ –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.

üß† –≠—Ç–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö, –≥–¥–µ –ø—Ä–∏–µ–º –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–¥—É—Ç –≤ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö.

---

## –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π TCP-—Å–µ—Ä–≤–µ—Ä

```c++
// server_async.cpp
using boost::asio::ip::tcp;

class session : public std::enable_shared_from_this<session> {
public:
    session(tcp::socket socket) : socket_(std::move(socket)) {}

    void start() {
        do_read();
    }

private:
    void do_read() {
        auto self(shared_from_this());
        socket_.async_read_some(boost::asio::buffer(data_),
            [this, self](boost::system::error_code ec, std::size_t length) {
                if (!ec) {
                    std::string msg(data_.data(), length);
                    std::cout << "Received: " << msg << std::endl;
                    do_read();
                }
            });
    }

    tcp::socket socket_;
    std::array<char, 1024> data_;
};

class server {
public:
    server(boost::asio::io_context& io_context, short port)
        : acceptor_(io_context, tcp::endpoint(tcp::v4(), port)) {
        do_accept();
    }

private:
    void do_accept() {
        acceptor_.async_accept(
            [this](boost::system::error_code ec, tcp::socket socket) {
                if (!ec) {
                    std::make_shared<session>(std::move(socket))->start();
                }
                do_accept();
            });
    }

    tcp::acceptor acceptor_;
};

int main() {
    try {
        boost::asio::io_context io_context;
        server s(io_context, 12345);
        io_context.run();
    } catch (std::exception& e) {
        std::cerr << "Exception: " << e.what() << "\n";
    }
}
```
---

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### boost::asio::io_context ‚Äî —á—Ç–æ —ç—Ç–æ?

`io_context` (`io_service`) ‚Äî —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç –≤ Boost.Asio, –∫–æ—Ç–æ—Ä—ã–π:

- –Ø–≤–ª—è–µ—Ç—Å—è "–¥–≤–∏–∂–∫–æ–º —Å–æ–±—ã—Ç–∏–π": –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (—á—Ç–µ–Ω–∏–µ, –∑–∞–ø–∏—Å—å, —Ç–∞–π–º–µ—Ä—ã –∏ —Ç.–¥.).
- –£–ø—Ä–∞–≤–ª—è–µ—Ç –æ—á–µ—Ä–µ–¥—å—é –∑–∞–¥–∞—á (completion handlers), –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å.
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ `run()`, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π.

### tcp::acceptor ‚Äî —á—Ç–æ —ç—Ç–æ?

`tcp::acceptor` ‚Äî —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É—à–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:

- –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ IP-–∞–¥—Ä–µ—Å—É –∏ –ø–æ—Ä—Ç—É —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ bind.
- –°–ª—É—à–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (listen()).
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (async_accept() –∏–ª–∏ accept()).
- –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å–æ–∑–¥–∞—ë—Ç—Å—è `tcp::socket`, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º.

### –ö–∞–∫ –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–µ–∑ –ø–æ—Ç–æ–∫–æ–≤?

–î–∞, –º–æ–∂–Ω–æ –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–µ–∑ –ø–æ—Ç–æ–∫–æ–≤, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π API Boost.Asio:

- async_accept() –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫.
- async_read() / async_write() –ø–æ–∑–≤–æ–ª—è—é—Ç —á–∏—Ç–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è.
- –í—Å–µ —Å–æ–±—ã—Ç–∏—è —Å—Ç–∞–≤—è—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å `io_context` –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏.

–ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º ‚Äî —ç—Ç–æ —Ä–µ–∞–∫—Ç–æ—Ä–Ω–∞—è –º–æ–¥–µ–ª—å: –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å —Ç—ã—Å—è—á–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∑–∞ —Å—á—ë—Ç –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –∫–æ–ª–±—ç–∫–æ–≤.

1. –¢—ã –≤—ã–∑—ã–≤–∞–µ—à—å, –Ω–∞–ø—Ä–∏–º–µ—Ä:

```c++
boost::asio::async_read(socket, buffer, handler);
```
Boost.Asio –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é —Å—Ä–∞–∑—É, –∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –µ—ë –≤ —Å–≤–æ–µ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ (**event loop**).

2. `io_context::run()` –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ü–∏–∫–ª —Å–æ–±—ã—Ç–∏–π
–≠—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª, –≤ –∫–æ—Ç–æ—Ä–æ–º:

- –ó–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è —Å–æ–±—ã—Ç–∏—è –æ—Ç –û–° —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã (epoll, select, IOCP, ...).
- –ö–æ–≥–¥–∞ –û–° —Å–æ–æ–±—â–∞–µ—Ç –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–Ω–∞ —ç—Ç–æ–º —Å–æ–∫–µ—Ç–µ –º–æ–∂–Ω–æ —á–∏—Ç–∞—Ç—å") ‚Äî Boost.Asio –≤—ã–∑—ã–≤–∞–µ—Ç —Ç–≤–æ–π handler.

```c++
    boost::asio::io_context io;
    tcp::acceptor acceptor(io, {...});
    start_accept(acceptor);

    io.run(); // –ø–æ—Ç–æ–∫ "–∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç" –∑–¥–µ—Å—å
 ```

### –ö–∞–∫ –∑–∞–ø—É—Å–∫–∞—Ç—å Boost.Asio –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ–Ω–æ–≤—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö

Boost.Asio –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ —Å–æ–∑–¥–∞–µ—Ç –ø–æ—Ç–æ–∫–∏ —Å–∞–º ‚Äî —Ç—ã —Å–∞–º —Ä–µ—à–∞–µ—à—å, —Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –Ω—É–∂–Ω–æ.
–ï—Å–ª–∏ —É —Ç–µ–±—è –º–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ / —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π ‚Äî –≤—ã–≥–æ–¥–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤:

```c++
boost::asio::io_context io_context;
boost::asio::executor_work_guard<boost::asio::io_context::executor_type> work_guard(io_context.get_executor());

std::vector<std::thread> threads;
for (int i = 0; i < std::thread::hardware_concurrency(); ++i) {
    threads.emplace_back([&io_context]() {
        io_context.run();  // –∫–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
    });
}

// ‚Ä¶ –ø–æ–∑–∂–µ
io_context.stop();
for (auto& t : threads) t.join();
```

**–ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç:**
- –†–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ I/O.
- –ö–∞–∂–¥–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Å–ª—É–∂–µ–Ω–æ –≤ –ª—é–±–æ–º –ø–æ—Ç–æ–∫–µ.
- –ù–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –ø–æ—Ç–æ–∫–∞–º.

--- 

### –ó–∞—á–µ–º –Ω—É–∂–µ–Ω —Ç–∞–π–º–∞—É—Ç –Ω–∞ connect / write / read

–ü–æ—Ç–æ–º—É —á—Ç–æ Asio –ù–ï —Ä–∞–∑—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ —Ç–∞–π–º-–∞—É—Ç—É!
–ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –º–æ–ª—á–∏—Ç, –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–≤–∏—Å ‚Äî —Ç–≤–æ–π `async_read()` **–º–æ–∂–µ—Ç –∂–¥–∞—Ç—å –≤–µ—á–Ω–æ**.

```c++

```

–ü–æ—á–µ–º—É Boost.Asio –Ω–µ –¥–µ–ª–∞–µ—Ç —Ç–∞–π–º–∞—É—Ç—ã —Å–∞–º?
- –û–Ω –Ω–µ –∑–Ω–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –∂–¥–∞—Ç—å ‚Äî —ç—Ç–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ª–æ–≥–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
- –û–Ω –¥–∞—ë—Ç —Ç–µ–±–µ –≥–∏–±–∫–æ—Å—Ç—å ‚Äî —Ç—ã —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—à—å: 5 —Å–µ–∫—É–Ω–¥? 30? –í—Å–µ–≥–¥–∞?

–ö–æ–≥–¥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏?
1. –£–¥–∞–ª—ë–Ω–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (TCP FIN)
`boost::asio::error::connection_reset` —ç—Ç–æ —Ä–µ–∞–∫—Ü–∏—è —É–∂–µ –Ω–∞ –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–π —Å—Ç–æ—Ä–æ–Ω–µ.
2. –õ–æ–∫–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–∫–µ—Ç–∞
```c++
socket.close();
socket.cancel();
```
–û–ø—è—Ç—å –∂–µ, —ç—Ç–æ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç—Å—è —Ç–æ–±–æ–π, –Ω–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

3. –û—à–∏–±–∫–∏ –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, connection reset)
- –£–¥–∞–ª—ë–Ω–Ω—ã–π —Ö–æ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ TCP (RST)
- –°–µ—Ç–µ–≤–æ–π –∫–∞–±–µ–ª—å –≤—ã–¥–µ—Ä–Ω—É–ª–∏

--- 