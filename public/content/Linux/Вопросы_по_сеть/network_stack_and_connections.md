# Сетевой стек и соединения в Linux

## Описание
Обзор сетевого стека Linux, работа с TCP/IP на уровне ОС.

## Вопросы и ответы

### Вопрос: Как устроен стек сетевых протоколов в Linux?
**Ответ:**  
Linux использует стек TCP/IP, включающий уровни: Ethernet → IP → TCP/UDP → сокеты. Взаимодействие происходит через сокеты (`socket()`, `bind()`, `accept()` и т.д.). Протоколы обрабатываются в ядре, а пользователь взаимодействует с ними через API.

### Вопрос: Как Linux обрабатывает TCP-соединения на низком уровне?
**Ответ:**  
Ядро отслеживает состояния TCP через TCP FSM (Finite State Machine), используя буферы и очереди. Сегменты проходят через iptables, netfilter и socket buffer. Приём/передача данных возможна с помощью системных вызовов `recv`, `send`, `poll`, `epoll`.

### Вопрос: Для чего нужны select/poll/epoll?

Они все используются для мультиплексирования ввода-вывода — то есть позволяют одновременно работать с множеством 
файловых дескрипторов (FD): сокеты, файлы, пайпы и т.д.

Например, если ты пишешь сетевой сервер, который должен одновременно обрабатывать тысячи клиентов 
— тебе нужно эффективно узнавать, **на каких сокетах есть данные для чтения, на какие можно писать и т.д.**.

| Механизм | Подход  | Проблемы| 
|----------|---------|----------|
| select   |Массив флагов	|Ограничение FD (обычно 1024), O(n), копирование |
| poll	    |Массив структур	| Нет ограничения FD, но всё ещё O(n) |
|  epoll	  | Событийная модель |	Масштабируемый, эффективный, O(1) |

Преимущества **epoll**:

- Масштабируемость — не зависит от числа FD (O(1) вместо O(n)).
- Без лимита на число FD — подходит для high-load серверов.
- Событийная модель — ядро само следит за событиями и не требует повторной передачи всех FD.
- Edge-triggered — можно обрабатывать события только при изменении состояния (меньше системных вызовов).
- Низкая нагрузка на CPU — ядро не сканирует все дескрипторы.
  
**Если у тебя есть 10000 подключений:**
- `select` или `poll` будут проверять все 10000 FD каждый раз.
- `epoll` будет просто ждать, пока ядро само не скажет, на каких FD появились события.