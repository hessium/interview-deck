# EXPLAIN ANALYZE и COST в планах выполнения запросов

## Описание

В этом документе рассматривается использование `EXPLAIN` и `EXPLAIN ANALYZE` в PostgreSQL и других СУБД для анализа планов выполнения SQL-запросов. Также разбирается значение метрики COST и влияние различных факторов на выбор плана.

---

## Вопросы и ответы

### ❓ Что такое `EXPLAIN` и `EXPLAIN ANALYZE`?

**EXPLAIN** — команда, которая выводит план выполнения SQL-запроса без фактического его выполнения.

**EXPLAIN ANALYZE** — выполняет запрос и показывает реальный план выполнения, включая время и количество строк на каждом этапе.

---

### ❓ Как интерпретировать вывод `EXPLAIN`?

Вывод `EXPLAIN` обычно включает:

- **Node Type** (например, Seq Scan, Index Scan)
- **Cost = start..end** — оценка затрат планировщика
- **Rows** — ожидаемое количество строк
- **Width** — средний размер строки в байтах

Пример:
```sql
EXPLAIN SELECT * FROM users WHERE id = 10;
```
Вывод:
```
Index Scan using users_pkey on users  (cost=0.29..8.30 rows=1 width=244)
```

---

### ❓ Что означают значения `COST`?

`COST` представлен в виде диапазона: `start..end`.

- **start** — стоимость начала выполнения операции.
- **end** — полная стоимость выполнения до конца.
- Затраты измеряются в абстрактных единицах (по умолчанию: последовательное чтение страницы = 1.0, поиск по индексу = 0.005 и т.д.).

Планировщик использует `COST`, чтобы выбрать наиболее эффективный путь выполнения.

---

### ❓ Как `EXPLAIN ANALYZE` отличается от `EXPLAIN`?

- `EXPLAIN ANALYZE` показывает **фактические** данные: сколько строк обработано, сколько времени заняла каждая операция.
- Позволяет сравнить ожидаемые значения с реальными (например, rows vs actual rows).

---

### ❓ Как `COST` влияет на выбор плана?

Планировщик выбирает план с наименьшими оценочными затратами. При этом учитываются:

- Размер таблиц
- Наличие индексов
- Статистика по данным (selectivity)
- Настройки конфигурации (random_page_cost, cpu_tuple_cost и др.)

Чем выше `COST`, тем медленнее запрос. `Index Scan` → низкий `COST`.

---

### ❓ Как использовать `EXPLAIN ANALYZE` для выявления проблем?

Сравниваются:
- **Ожидаемые строки (rows)** vs **Фактические строки (actual rows)**
- **Ожидаемое время (cost)** vs **Фактическое время (actual time)**

Если расхождения велики, возможно:
- Устарела статистика (`ANALYZE`)
- Не используются индексы
- Запрос можно переписать более эффективно

---


### ❓ На что смотреть в EXPLAIN, чтобы понять, что индексы не работают?

Вот основные признаки:

| Что в EXPLAIN | Что это значит                                                           |
|------------|--------------------------------------------------------------------------|
| Seq Scan | 	**Последовательное чтение таблицы** — индекс не используется.           |
| Rows Removed by Filter | PostgreSQL **читает все строки**, а потом **отфильтровывает** ненужные.  |
| Filter:	| Условие применяется после чтения, т.е. не через индекс.                  |
| Bitmap Heap Scan + Bitmap Index Scan | Индекс **используется, но в неэффективной форме**, часто при `OR`, `IN`, `<>`. |
 | Index Scan или Index Only Scan | Идеально! Идёт **прямой доступ** по индексу.            <br/>                 |

**Пример плохого плана:**
```sql
Seq Scan on users  (cost=0.00..10000.00 rows=5000 width=...) 
  Filter: (name = 'Вася')
```
**Пример хорошего:**
```sql
Index Scan using idx_users_name on users  (cost=0.43..5.00 ...)
  Index Cond: (name = 'Вася')
```